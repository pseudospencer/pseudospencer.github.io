<html>
  <head>
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>

    <script src="//cdn.rawgit.com/donmccurdy/aframe-physics-system/v1.4.2/dist/aframe-physics-system.min.js"></script>
    
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>

    <script type="text/javascript">
      AFRAME.registerComponent('follow-camera', {
        init: function () {
        },
        schema: {
          maxY: {type: 'float', default: 50},
          minY: {type: 'float', default: 1},
          bankX: {type: 'float', default: 3},
          bankZ: {type: 'float', default: 3},
        },
        tick: function() {
          let camera = document.querySelector('#camera').object3D;
          let d = camera.getWorldDirection();

          let carGeometry = document.querySelector('#my-car-geometry').object3D;

          let directionY = ( ( 1 - camera.rotation.y / 3.14 ) % 1 );
          let directionX = ( ( camera.rotation.x / 3.14 ) % 1 );

          // console.log( ( 1 - camera.rotation.y / 3.14 ) % 1 );
          this.el.object3D.rotation.y += -.1  * directionY;

          carGeometry.rotation.x = -this.data.bankX * directionX;
          carGeometry.rotation.z = this.data.bankZ * directionY;

          d.multiplyScalar(-.3);


          if( this.el.object3D.position.y > this.data.maxY && d.y > 0 )
            d.y = 0;
          else if( this.el.object3D.position.y < this.data.minY && d.y < 0 )
            d.y = 0;

          this.el.object3D.position.add(d);

        }
      });

      AFRAME.registerComponent('auto-reset-position', {
        init: function () {
        },
        schema: {
          maxDistance: {type: 'float', default: 50},
        },
        tick: function() {
          let camera = document.querySelector('#camera').object3D;
          let body = this.el.body;
          let cameraPosition = camera.getWorldPosition();

          //calulate distance
          let a = cameraPosition.x - body.position.x;
          let b = cameraPosition.z - body.position.z;
          let d = Math.sqrt( a*a + b*b );

          if( d > this.data.maxDistance ) {
            let p = cameraPosition.add(camera.getWorldDirection().multiplyScalar(-40));
            p.y = 20;
            p.x += (Math.random() * 20) - 10;
            p.z += (Math.random() * 20) - 10;
            body.position.copy(p);
            body.velocity.set(0,0,0);
            body.angularVelocity.set(0,0,0);
          }

        }

      });
    </script>
  </head>
  <body>
    <a-scene shadow >
      
      <a-assets>

        <a-asset-item id="flying-car-body-obj" src="/models/flying-car_body.obj"></a-asset-item>
        <a-asset-item id="flying-car-body-mtl" src="/models/flying-car_body.mtl"></a-asset-item>
        <a-asset-item id="flying-car-frame-obj" src="/models/flying-car_frame.obj"></a-asset-item>
        <a-asset-item id="flying-car-frame-mtl" src="/models/flying-car_frame.mtl"></a-asset-item>

        <video id="me-video" autoplay loop="true" src="/video/me.m4v" muted></video>
        <audio id="me-audio" loop="true" src="/audio/me.m4a"></audio>

        <audio id="sample-audio" loop="true" src="/audio/sample.mp3"></audio>

        <a-cubemap id="sky-cubemap">
          <img src="/images/cubemap/px.png">
          <img src="/images/cubemap/nx.png">
          <img src="/images/cubemap/py.png">
          <img src="/images/cubemap/ny.png">
          <img src="/images/cubemap/pz.png">
          <img src="/images/cubemap/nz.png">
        </a-cubemap>

      </a-assets>

      <a-entity environment="preset: osiris; skyColor: #55a6ff; horizonColor: #f0cacd; shadow: true; lightPosition: 0 13 0; fog: 0.67; groundColor: #5639ac; dressingAmount: 0; grid: none; shadowSize: 2"></a-entity>

      <a-entity static-body="box" id="my-car" sound="src: #sample-audio; loop: true;" soundplaybackrate="1" position="0 2 -50" follow-camera>
      
        <a-entity id="my-car-geometry">

          <a-entity static-body="shape: box" obj-model="obj: #flying-car-body-obj;" 
            material="
              src:/images/tiger-texture.png;
              envMap: #sky-cubemap;
              metalness:.8;
              roughness:0;"
            shadow="cast:true">
          </a-entity>
  
          <a-entity obj-model="obj: #flying-car-frame-obj; mtl: #flying-car-frame-mtl" shadow="cast:true"></a-entity>
        
          <a-animation attribute="position" dur="1000" to="0 .5 0" easing="ease-in-out-sine"  direction="alternate" repeat="indefinite"></a-animation>
        
        </a-entity>

        <a-entity light="type:point;castShadow:true;" position="0.051 10 0.628"></a-entity>
      
        <a-entity id="camera" camera="userHeight: 1" rotation="0 180 0" position="0 0 -2" look-controls>
          <a-cursor></a-cursor>
        </a-entity>
        
      </a-entity>

      <a-entity auto-reset-position dynamic-body geometry="primitive:box;" position="0 10 10" scale="3 3 3" material="color:red;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: sphere;" geometry="primitive:sphere;" position="0 10 10" scale="3 3 3" material="color:green;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: cylinder;" geometry="primitive:cylinder;" position="0 10 10" scale="3 3 3" material="color:blue;"></a-entity>

      <a-entity auto-reset-position dynamic-body geometry="primitive:box;" position="0 10 10" scale="3 3 3" material="color:red;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: sphere;" geometry="primitive:sphere;" position="0 10 10" scale="3 3 3" material="color:green;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: cylinder;"  geometry="primitive:cylinder;" position="0 10 10" scale="3 3 3" material="color:blue;"></a-entity>      <a-entity dynamic-body geometry="primitive:box;" position="0 10 10" scale="3 3 3" material="color:red;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: sphere;" geometry="primitive:sphere;" position="0 10 10" scale="3 3 3" material="color:green;"></a-entity>
      
      <a-entity auto-reset-position dynamic-body="shape: cylinder;"  geometry="primitive:cylinder;" position="0 10 10" scale="3 3 3" material="color:blue;"></a-entity>

      <a-plane visible="false" static-body width="1000" height="1000" rotation="-90 0 0"></a-plane>

      <a-entity light="type: ambient; intensity: .3" ></a-entity>

    </a-scene>

  </body>
</html>
