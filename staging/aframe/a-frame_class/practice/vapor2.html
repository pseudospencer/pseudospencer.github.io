<!DOCTYPE html>
<html>

<head>
    <!-- A-frame -->
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <!-- A-frame Environment -->
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <!-- Custom Components -->
    <script type="text/javascript">
        AFRAME.registerComponent("goat-cam", {
            schema: {
                maxY: { type: 'float', default: 50 },
                minY: { type: 'float', default: 1 },
                bankX: { type: 'float', default: 3 },
                bankZ: { type: 'float', default: 3 },
            },
            init: function() {
                console.log("goat-cam attach");
                let goat = this.el;
                goat.setAttribute("rotation", '0 -90 0');

            },
            tick: function(time, timeDelta) {
                let vector = this.vector;

                let goat = this.el.object3D;
                let camera = document.querySelector('#camera').object3D;

                // let cameraPosition = camera.getWorldPosition();
                // let cameraDirection = camera.getWorldDirection();
                //
                // let directionY = ( ( 1 - camera.rotation.y / Math.PI ) % 1 );
                //
                // // Turn Goat
                // console.log(goat.rotation.y / (Math.PI/180));
                // if (goat.rotation.y > (-270 * Math.PI/180) && goat.rotation.y <  (0 * Math.PI/180) ) {
                //     goat.rotation.y += -.1  * directionY;
                // }
                //
                // let p = cameraPosition.add(cameraDirection.multiplyScalar(-3));
                // p.y = 0;
                //
                // goat.position.copy(p);


                // cameraDirection.multiplyScalar(-.1);
                // if ( goat.position.y > this.data.maxY && cameraDirection.y > 0 ) {
                //     cameraDirection.y = 0;
                // } else if ( goat.position.y < this.data.minY && cameraDirection.y < 0 ) {
                //     cameraDirection.y = 0;
                // }
                //
                // goat.position.add(cameraDirection);
                // camera.position.add(cameraDirection);

            }
        });

        AFRAME.registerComponent('follow', {
            schema: {
                target: { type: 'selector', default: "#camera"},
                speed: { type: 'number', default: .3},
            },
            init: function() {
                this.directionVec3 = new THREE.Vector3();
            },
            tick: function(time, timeDelta) {
                var directionVec3 = this.directionVec3;
                // Grab positionvectors(THREE.Vector3) from the entities ' three.js objects.
                var targetPosition = this.data.target.object3D.position;
                var currentPosition = this.el.object3D.position;
                // Subtract the vectors to get the direction the entity should head in.
                directionVec3.copy(targetPosition).sub(currentPosition);
                // Calculate the distance.
                var distance = directionVec3.length();
                // Don't go any closer if a close proximity has been reached.
                if (distance < 1) { return; }
                // Scale the direction vector 's magnitude down to match the speed.
                var factor = this.data.speed / distance;
                ['x ', 'y ', 'z '].forEach(function(axis) {
                    directionVec3[axis] *= factor * (timeDelta / 1000);
                });
                // Translate the entity in the direction towards the target.
                this.el.setAttribute('position', {
                    x: currentPosition.x + directionVec3.x,
                    y: currentPosition.y + directionVec3.y - 2,
                    z: currentPosition.z + directionVec3.z + 3
                });
            }
        });
    </script>
</head>

<body>
    <a-scene>

        <a-assets>
            <!-- Goat -->
            <a-asset-item id="goat-obj" src="/models/goat.obj"></a-asset-item>
            <!-- Wolf -->
            <a-asset-item id="rat-obj" src="/models/rat.obj"></a-asset-item>
            <!-- Rat -->
            <a-asset-item id="wolf-obj" src="/models/wolf.obj"></a-asset-item>
            <!-- Prince's "When Doves Cry" -->
            <audio id="when-doves-cry" loop="true" src="/audio/when_doves_cry.mp3"></audio>
        </a-assets>

        <!-- ENVIRONMENT - kind of a vaporwave mushroom land-->
        <a-entity environment="preset: tron; skyColor: #9e15f3; horizonColor: #21fc64; shadow: true; fog: 0.21; ground: noise; groundYScale: 10; groundColor: #2714b8; dressing: mushrooms; dressingColor: #fd8d70; dressingVariance: 18 5 20; gridColor: #e22c88" id="environment"></a-entity>

        <!-- Camera -->
        <a-entity id="camera" camera="userHeight: 1" position="0 1 2" rotation="0 180 0" look-controls wasd-controls>
            <!-- Audio Container -->
            <a-entity id="prince-player" sound="src: #when-doves-cry; loop: true;" soundplaybackrate="1"></a-entity>
        </a-entity>

        <!-- Ambient light -->
        <a-entity light="type: ambient; intensity: .2"></a-entity>

    </a-scene>

    <script type="text/javascript">
        let scene = document.querySelector('a-scene');
        let camera = document.querySelector("#camera");

        let ratContainer = document.createElement("a-entity");
            ratContainer.setAttribute("id", "rat-container");
        scene.appendChild(ratContainer);

        let rats = [];

        for (let i = 0; i< 12; i++) {
            rats[i] = createRat( 3, i, i, ratContainer);
            addRotateAnimation(rats[i]);
            addJumpAnimation(rats[i]);

        }

        let goat = createGoat(0, 0, 2);
            goat.setAttribute("rotation", {x: 0, y: -90, z: 0});
            // goat.setAttribute("goat-cam", '');
            goat.setAttribute("follow", "");

        function createGoat(x, y, z, appendTo = scene) {
            let goat = document.createElement("a-entity");
            goat.setAttribute('obj-model', "obj", "#goat-obj");
            goat.setAttribute("class", "goat");
            goat.setAttribute("position", `${x} ${y} ${z}`);
            goat.setAttribute("material", "color: pink;");
            goat.setAttribute("scale", ".002 .002 .002");

            appendTo.appendChild(goat);
            return goat;
        }

        function createWolf(x, y, z, appendTo = scene) {
            let wolf = document.createElement("a-entity");
            wolf.setAttribute("obj-model", "obj", "#wolf-obj");
            wolf.setAttribute("class", "wolf");
            wolf.setAttribute("position", `${x} ${y} ${z}`);
            wolf.setAttribute("material", "color: green;");
            wolf.setAttribute("scale", ".002 .002 .002");

            appendTo.appendChild(wolf);
            return wolf;
        }

        function createRat(x, y, z, appendTo = scene) {
            let rat = document.createElement("a-entity");
            rat.setAttribute("obj-model", "obj", "#rat-obj");
            rat.setAttribute("class", "rat");
            rat.setAttribute("position", `${x} ${y} ${z}`);
            rat.setAttribute("material", "color: gold;");
            rat.setAttribute("scale", ".02 .02 .02");

            appendTo.appendChild(rat);
            return rat;
        }

        function addRotateAnimation(eleToAnimate) {
            let animation = document.createElement("a-animation");
            animation.setAttribute("attribute", "rotation");
            animation.setAttribute("dur", "1000");
            animation.setAttribute("repeat", "indefinite");
            animation.setAttribute('direction', "alternate");
            animation.setAttribute("to", "0 0 90");

            eleToAnimate.appendChild(animation);

        }

        function addJumpAnimation(eleToAnimate) {
            let animation = document.createElement("a-animation");
            animation.setAttribute("attribute", "position");
            animation.setAttribute("dur", "1000");
            animation.setAttribute("repeat", "indefinite");
            animation.setAttribute('direction', "alternate");
            animation.setAttribute("to", "0 5 4");
            animation.setAttribute("delay", "100");

            eleToAnimate.appendChild(animation);
        }

        // Autoplay Music
        document.querySelector('a-scene').addEventListener('loaded', function() {
            let iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (iOS) {
                function startAudio() {
                    let entity = document.querySelector('#prince-player');
                    entity.components.sound.playSound();

                    document.body.removeEventListener('click', startAudio);
                }
                document.body.addEventListener('click', startAudio);
            } else {
                let entity = document.querySelector('#prince-player');
                entity.components.sound.playSound();
            }
        })
    </script>
</body>

</html>
