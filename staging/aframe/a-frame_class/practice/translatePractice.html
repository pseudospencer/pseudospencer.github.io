<!DOCTYPE html>
<html>

<head>
    <!-- A-frame -->
    <script src="https://aframe.io/releases/0.6.1/aframe.min.js"></script>
    <!-- A-frame Environment -->
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>
    <!-- Custom components -->
    <script type="text/javascript">
        AFRAME.registerComponent('follow', {
            schema: {
                target: { type: 'selector', default: "#camera"},
                speed: { type: 'number', default: .3},
            },
            init: function() {
                this.directionVec3 = new THREE.Vector3();
            },
            tick: function(time, timeDelta) {

                var directionVec3 = this.directionVec3;

                // Grab positionvectors(THREE.Vector3) from the entities ' three.js objects.
                var targetPosition = this.data.target.object3D.position;
                var currentPosition = this.el.object3D.position;

                // Subtract the vectors to get the direction the entity should head in.
                directionVec3.copy(targetPosition).sub(currentPosition);

                // Calculate the distance.
                var distance = directionVec3.length();

                // Don't go any closer if a close proximity has been reached.
                if (distance < 1) { return; }

                // Scale the direction vector 's magnitude down to match the speed.
                var factor = this.data.speed / distance;
                ['x ', 'y ', 'z '].forEach(function(axis) {
                    directionVec3[axis] *= factor * (timeDelta / 1000);
                });

                // Translate the entity in the direction towards the target.
                this.el.setAttribute('position', {
                    x: currentPosition.x + directionVec3.x,
                    y: currentPosition.y + directionVec3.y - 2,
                    z: currentPosition.z + directionVec3.z + 3
                });
            }
        });
    </script>
</head>

<body>
    <a-scene>
        <a-assets>
            <a-asset-item id="goat-obj" src="/models/goat.obj"></a-asset-item>
        </a-assets>

        <a-entity environment="preset: tron; skyColor: #9e15f3; horizonColor: #21fc64; shadow: true; fog: 0.21; ground: noise; groundYScale: 10; groundColor: #2714b8; dressing: mushrooms; dressingColor: #fd8d70; dressingVariance: 18 5 20; gridColor: #e22c88" id="environment"></a-entity>

        <!-- <a-entity id="camera" camera="userHeight: 1" position="0 1 2" rotation="0 180 0" look-controls wasd-controls></a-entity> -->
        <a-entity id="camera" camera="userHeight: 1" position="0 1 2" rotation="0 180 0"></a-entity>

    </a-scene>

    <script type="text/javascript">
        let scene = document.querySelector('a-scene');

        let camera = document.querySelector("#camera");
            camera.setAttribute("look-controls", "");
            camera.setAttribute("wasd-controls", "");

        let goat = createGoat(0, 0, 3);
            goat.setAttribute("rotation", {x: 0, y: -90, z: 0});
            goat.setAttribute('id', "the-goat");
            goat.setAttribute("follow", "");

        function createGoat(x, y, z, appendTo = scene) {
            let goat = document.createElement("a-entity");
            goat.setAttribute('obj-model', "obj", "#goat-obj");
            goat.setAttribute("class", "goat");
            goat.setAttribute("position", `${x} ${y} ${z}`);
            goat.setAttribute("material", "color: pink;");
            goat.setAttribute("scale", ".002 .002 .002");

            appendTo.appendChild(goat);
            return goat;
        }
    </script>
</body>

</html>
