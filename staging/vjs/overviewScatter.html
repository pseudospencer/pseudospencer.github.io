<!DOCTYPE html>
<html>

<head>
	<!-- Based on this tutorial: https://bost.ocks.org/mike/bar/3/ -->
	<meta charset="utf-8">
	<title>VJS: Overview Scatter</title>
	<!-- <link rel="stylesheet" type="text/css" href="vjs_style.css"> -->
	<style>

		body {
	  		font: 10px sans-serif;
		}

		.axis path,
		.axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}

		.d3-tip {
			line-height: 1;
			/*font-weight: bold;*/
			padding: 12px;
			background: rgba(0, 0, 0, 0.8);
			color: #fff;
			border-radius: 2px;
		}

		/* Creates a small triangle extender for the tooltip */
		.d3-tip:after {
			box-sizing: border-box;
			display: inline;
			font-size: 10px;
			width: 100%;
			line-height: 1;
			color: rgba(0, 0, 0, 0.8);
			content: "\25BC";
			position: absolute;
			text-align: center;
		}

		/* Style northward tooltips differently */
		.d3-tip.n:after {
			margin: -1px 0 0 0;
			top: 100%;
			left: 0;
		}

	</style>
	<!-- Load D3 -->
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<!-- D3 Tip: Usage example - http://bl.ocks.org/Caged/6476579 -->
	<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
</head>

<body>

	<div class="chart1"></div>

	<!-- Script for chart 1 -->
	<script>
		var margin = {
				top: 20,
				right: 40,
				bottom: 30,
				left: 40
			},
			w = 960 - margin.left - margin.right,
			h = 500 - margin.bottom - margin.top,
			dimensions = {
				overallRating : { key: "overallRating", label: "Overall Rating"},
				workLifeBalanceRating : {key: "workLifeBalanceRating", label: "Work Life Balance Rating"},
				compensationAndBenefitsRating : {key: "compensationAndBenefitsRating", label: "Compensation and Benefits Rating"},
				cultureAndValuesRating : {key: "cultureAndValuesRating", label: "Culture and Values Rating"},
				careerOpportunitiesRating : {key: "careerOpportunitiesRating", label: "Career Opportunities Rating"}
			}
			param1 = "overallRating",
			param2 = "workLifeBalanceRating", // Starting values for a field name - must be string.
			xLabel = dimensions[param1].label,
			yLabel = dimensions[param2].label,
			dataset = '';

		// Setup X
		var xValue = function(d) {
			return d[param1];
		};

		var xScale = d3.scale.linear()
			.range([0, w]); // domain after datafile load

		var xMap = function(d) {
			return xScale(xValue(d));
		};

		var xAxis = d3.svg.axis()
			.scale(xScale)
			.orient("bottom");

		// Setup Y
		var yValue = function(d) {
			return d[param2];
		};

		var yScale = d3.scale.linear()
			.range([h, 0]); // domain after datafile load

		var yMap = function(d) {
			return yScale(yValue(d));
		};

		var yAxis = d3.svg.axis()
			.scale(yScale)
			.orient("left");

		// Create dropdowns for dimension selection
		var dropdownContainer = d3.select(".chart1") // make a div
			.append("div")
			.attr({
				"class": "dimensions"
			});

		var d1Label = d3.select(".dimensions") // create a <select> in that div
			.append("span")
				.text("Value for X axis: ");

		var d1 = d3.select(".dimensions") // create a <select> in that div
			.append("select")
				.attr({
					"class": "select",
					"id": "param1Select",
				})
				.on("change", updateParams);

		var d1_params = d1 // create <options>
			.selectAll('option')
			.data(d3.keys(dimensions))
			.enter()
			.append("option")
			.attr("selected", function(d) {
				// if this option is the same as param1, make it "selected" by default
				// console.log(d, dimensions[d].key, param1, dimensions[d].key === param1)
				if (dimensions[d].key === param1) {
					return true;
				} else {
					return null; // if value is null, it doesn't apply the attribute
				}
			})
			.text(function(d) {
				return dimensions[d].label;
			});

		var d2Label = d3.select(".dimensions") // create a <select> in that div
			.append("span")
				.text("  Value for Y axis: ");

		var d2 = d3.select(".dimensions") // create a <select> in that div
			.append("select")
				.attr({
					"class": "select",
					"id": "param2Select",
				})
				.on("change", updateParams);

		var d2_params = d2 // create <options>
			.selectAll('option')
			.data(d3.keys(dimensions))
			.enter()
			.append("option")
			.attr("selected", function(d) {
				// if this option is the same as param1, make it "selected" by default
				// console.log(d, dimensions[d].key, param1, dimensions[d].key === param1)
				if (dimensions[d].key === param2) {
					return true;
				} else {
					return null; // if value is null, it doesn't apply the attribute
				}
			})
			.text(function(d) {
				return dimensions[d].label;
			});

		// Scatter Plot tooltips, using d3 Tip: http://bl.ocks.org/Caged/6476579
		var tip = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([-10, 0])
		  .html(function(d) {
			var xVal = d[param1], yVal = d[param2];
		    return "<span style='color:orange'><strong>" + d.companyName + ": </strong></span>"+ xLabel +": " + xVal + ", " + yLabel + ": " + yVal;
		  })

		// create chart SVG
		var chart1 = d3.select("body").select(".chart1")
			.append("svg")
			.attr({
				"width": w + margin.left + margin.right,
				"height": h + margin.top + margin.bottom,
			})
			.append("g")
			.attr({
				"transform": "translate(" + margin.left + "," + margin.top + ")",
				"id": "chart1-body",
			});

		// Initialize tooltips within context
		chart1.call(tip);

		// Load Datafile
		d3.csv("jobs_data_master_v1_10.30.16.csv", function(error, data) {

			dataset = data;

			// force strings (from CSV) into numbers
			data.forEach(function(d) {
				d.overallRating = +d.overallRating;
				d.workLifeBalanceRating = +d.workLifeBalanceRating;
				d.compensationAndBenefitsRating = +d.compensationAndBenefitsRating;
				d.cultureAndValuesRating = +d.cultureAndValuesRating;
				d.careerOpportunitiesRating = +d.careerOpportunitiesRating;
				// console.log(d.companyName, d);
			});

			// Set scale domains
			xScale.domain([d3.min(data, xValue) - .1, d3.max(data, xValue) + .1]);
			yScale.domain([d3.min(data, yValue) - .1, d3.max(data, yValue) + .1]);

			// Add x Axis
			chart1.append("g")
				.attr({
					"class": "x axis",
					"transform": "translate(0," + h + ")"
				})
				.call(xAxis)
				.append("text")
				.text(xLabel)
				.attr({
					"class": "label",
					"x": w,
					"y": -6,
				})
				.style("text-anchor", "end");

			// Add y axis
			chart1.append("g")
				.attr({
					"class": "y axis",
				})
				.call(yAxis)
				.append("text")
				.text(yLabel)
				.attr({
					"class": "label",
					"transform": "rotate(-90)",
					"y": 6,
					"dy": ".71em"
				})
				.style("text-anchor", "end");

			// Render points
			chart1.selectAll("circle")
				.data(data)
				.enter()
				.append("circle")
				.attr({
					"r": 3,
					"cx": xMap,
					"cy": yMap,
					// "fill": "none",
					"stroke": "black",
				})
				.on("mouseover", tip.show)
				.on("mouseout", tip.hide);
		});

		function updateParams() {
			selectValue1 = d3.select('#param1Select').property('value');
			selectValue2 = d3.select('#param2Select').property('value');
			data = d3.keys(dimensions)
			for (var i = 0; i < data.length; i++) {
				if (selectValue1 == dimensions[data[i]].label){
					param1 = dimensions[data[i]].key;
				}
				if (selectValue2 == dimensions[data[i]].label){
					param2 = dimensions[data[i]].key;
				}
			};
			updateChart();
		};

		function updateAxisLabelValues() {
			xLabel = dimensions[param1].label, yLabel = dimensions[param2].label;
		}

		function updateScaleDomains() {
			xScale.domain([d3.min(dataset, xValue) - .1, d3.max(dataset, xValue) + .1]);
			yScale.domain([d3.min(dataset, yValue) - .1, d3.max(dataset, yValue) + .1]);
		}

		function updateChart() {
			updateScaleDomains();
			updateAxisLabelValues();

			// update X Axis
			chart1.select(".x.axis")
				.transition()
				.duration(1000)
				.select(".label")
				.text(xLabel)
				.call(xAxis);

			// update Y Axis
			chart1.select(".y.axis")
				.transition()
				.duration(1000)
				.select(".label")
				.text(yLabel)
				.call(yAxis);

			// update points
			chart1.selectAll("circle")
				.data(dataset)
				.transition()
				.duration(1000)
				.attr({
					"cx": xMap,
					"cy": yMap,
				});
		}
	</script>
</body>

</html>
